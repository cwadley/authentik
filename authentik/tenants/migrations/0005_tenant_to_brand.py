# Generated by Django 4.2.7 on 2023-11-06 19:48

from django.db import migrations

CONTENT_TYPE_SWAP = """
UPDATE django_content_type
    SET app_label = CASE app_label
        WHEN 'authentik_tenants' THEN 'authentik_brands'
        WHEN 'authentik_brands' THEN 'authentik_tenants'
    END
    WHERE app_label = 'authentik_brands' OR app_label = 'authentik_tenants';
UPDATE django_content_type
    SET model = CASE model
        WHEN 'tenant' THEN 'brand'
        WHEN 'brand' THEN 'tenant'
    END
    WHERE app_label = 'authentik_brands' OR app_label = 'authentik_tenants';
"""

# Columns need to be specified explicitly as their order changes because we're recreating a brand new table
COLUMNS_TO_MIGRATE = [
    "domain",
    "default",
    "branding_title",
    "branding_logo",
    "branding_favicon",
    "flow_authentication_id",
    "flow_invalidation_id",
    "flow_recovery_id",
    "flow_unenrollment_id",
    "flow_user_settings_id",
    "flow_device_code_id",
    "event_retention",
    "web_certificate_id",
    "attributes",
]
COLUMNS_TO_MIGRATE_SQL = ",".join(map(lambda column: f'"{column}"', COLUMNS_TO_MIGRATE))


class Migration(migrations.Migration):
    dependencies = [
        ("authentik_tenants", "0004_tenant_flow_device_code"),
        ("authentik_brands", "0001_initial"),
    ]

    operations = [
        migrations.RunSQL(
            sql=CONTENT_TYPE_SWAP
            + f"""
            INSERT INTO authentik_brands_brand("brand_uuid", {COLUMNS_TO_MIGRATE_SQL}) SELECT "tenant_uuid", {COLUMNS_TO_MIGRATE_SQL} FROM authentik_tenants_tenant;
            TRUNCATE authentik_tenants_tenant;
            """,
            reverse_sql=CONTENT_TYPE_SWAP
            + """
            INSERT INTO authentik_tenants_tenant("tenant_uuid", {COLUMNS_TO_MIGRATE_SQL}) SELECT "brand_uuid", {COLUMNS_TO_MIGRATE_SQL} FROM authentik_brands_brand;
            TRUNCATE authentik_brands_brand;
            """,
        ),
    ]
